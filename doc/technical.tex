\section{Design and Implementation}

\texttt{z3.rkt} is currently implemented as a few hundred lines of Racket code
that interface with the Z3 engine via the provided library. Since the system is
still a work in progress, some of these details might change in the future.

\textbf{The Z3 wrapper.} We use Racket's foreign interface \cite{racket/foreign}
to map the Z3 library's C functions into Racket. The programmer interface
communicates with Z3 by calling the Racket functions defined by the
wrapper. While it is possible to use the Z3 wrapper directly, we highly
recommend using the programmer interface instead.

\textbf{The programmer interface.} This is a small set of Racket macros and
functions layered on top of the Z3 wrapper. As noted in Section~\ref{sec:motiv},
the aim of the interface is to hide the complexities of the C wrapper and stay
as close to the SMT-LIB version 2 standard \cite{smtlib2:10} as possible, while
extending it in useful ways.

We use a separate Racket namespace to store user-defined constants and functions
in. Thus a command of the form \texttt{(smt:declare-fun x () Int)} will not
create a binding for \texttt{x} in the caller's namespace. The reason for this
is that several functions built into the SMT-LIB specification (such as
\texttt{=} and \texttt{<=}) collide with Racket-provided symbols. However, the
system does let the programmer substitute values from her own namespace using
the \texttt{unquote} form familiar to Lisp programmers (usually shortened to a
prefixed comma). So the following code asserts that \texttt{x} is 20.

\begin{verbatim}
(smt:declare-fun x () Int)
(define n 20)
(smt:assert (= x ,n))
\end{verbatim} 
